BootStrap: docker
From: ubuntu:16.04

%post
    # 1. System Essentials
    apt-get update && apt-get install -y --no-install-recommends \
        wget curl git build-essential gcc g++ make zlib1g-dev \
        libncurses5-dev libbz2-dev liblzma-dev libcurl4-gnutls-dev \
        libssl-dev libxml2-dev python2.7 python-pip python-dev \
        software-properties-common apt-transport-https

    # 2. Install R 3.4.1
    # We use the CRAN archive for Ubuntu 16.04
    gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys E298A3A825C0D65DFD57CBB651716619E084DAB9
    gpg -a --export E298A3A825C0D65DFD57CBB651716619E084DAB9 | apt-key add -
    add-apt-repository 'deb https://cloud.r-project.org/bin/linux/ubuntu xenial/'
    apt-get update
    apt-get install -y r-base=3.4.1-1xenial0 r-base-dev=3.4.1-1xenial0

    # 3. Install Bioinformatics Tools (Pre-compiled binaries where possible)
    # STAR 2.5.3a
    wget https://github.com/alexdobin/STAR/archive/2.5.3a.tar.gz
    tar -xzf 2.5.3a.tar.gz && cd STAR-2.5.3a/source && make STAR && cp STAR /usr/local/bin/ && cd ../..

    # Samtools 1.1
    wget https://github.com/samtools/samtools/releases/download/1.1/samtools-1.1.tar.bz2
    tar -xjf samtools-1.1.tar.bz2 && cd samtools-1.1 && make && make install && cd ..

    # Bedtools 2.25.0
    wget https://github.com/arq5x/bedtools2/releases/download/v2.25.0/bedtools-2.25.0.tar.gz
    tar -xzf bedtools-2.25.0.tar.gz && cd bedtools2 && make && cp bin/* /usr/local/bin/ && cd ..

    # StringTie 1.3.3
    wget http://ccb.jhu.edu/software/stringtie/dl/stringtie-1.3.3.Linux_x86_64.tar.gz
    tar -xzf stringtie-1.3.3.Linux_x86_64.tar.gz && cp stringtie-1.3.3.Linux_x86_64/stringtie /usr/local/bin/

    # 4. Install SQuIRE itself
    pip install squire

    # 5. Install R Packages
    # We use a script to ensure Bioconductor 3.5 (compatible with R 3.4) is used
    R --slave -e 'source("https://bioconductor.org/biocLite.R"); \
        biocLite(c("vsn", "DESeq2", "BiocParallel")); \
        install.packages(c("pheatmap", "RColorBrewer", "ggplot2", "ggrepel"), repos="http://cran.rstudio.com/")'

%environment
    export LC_ALL=C
    export PATH=/usr/local/bin:$PATH

%runscript
    exec squire "$@"