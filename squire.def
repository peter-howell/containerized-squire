Bootstrap: docker
From: rocker/r-ver:3.4.1

%post
    export DEBIAN_FRONTEND=noninteractive
    
    # 1. Install System Dependencies
    apt-get update && apt-get install -y \
        build-essential wget curl git zlib1g-dev libncurses5-dev \
        libbz2-dev liblzma-dev libcurl4-gnutls-dev libssl-dev \
        libxml2-dev python-dev python-pip

    # 2. Install Bioinfo Tools (Direct Binaries to avoid compilation errors)
    # STAR 2.5.3a
    wget https://github.com/alexdobin/STAR/archive/2.5.3a.tar.gz
    tar -xzf 2.5.3a.tar.gz && cd STAR-2.5.3a/source && make STAR && mv STAR /usr/local/bin/ && cd ../..

    # Samtools 1.1
    wget https://github.com/samtools/samtools/releases/download/1.1/samtools-1.1.tar.bz2
    tar -xjf samtools-1.1.tar.bz2 && cd samtools-1.1 && make && make install && cd ..

    # Bedtools 2.25.0
    wget https://github.com/arq5x/bedtools2/releases/download/v2.25.0/bedtools-2.25.0.tar.gz
    tar -xzf bedtools-2.25.0.tar.gz && cd bedtools2 && make && make install && cd ..

    # StringTie 1.3.3
    wget http://ccb.jhu.edu/software/stringtie/dl/stringtie-1.3.3.Linux_x86_64.tar.gz
    tar -xzf stringtie-1.3.3.Linux_x86_64.tar.gz && mv stringtie-1.3.3.Linux_x86_64/stringtie /usr/local/bin/

    # 3. Install R Packages using a MRAN snapshot (Fixed in time to 2017)
    # This prevents modern versions of ggplot2 etc. from breaking R 3.4.1
    R -e 'options(repos = c(CRAN = "https://cran.microsoft.com/snapshot/2017-09-01/")); \
        install.packages(c("pheatmap", "RColorBrewer", "ggplot2", "ggrepel", "vsn"));'
    
    # Install Bioconductor 3.5 (The correct version for R 3.4)
    R -e 'source("https://bioconductor.org/biocLite.R"); \
        biocLite(c("DESeq2", "BiocParallel"), ask=FALSE)'

    # 4. Install SQuIRE
    git clone https://github.com/Yanshu-Li/SQuIRE.git
    cd SQuIRE && python setup.py install

%environment
    export LC_ALL=C
    export PATH=/usr/local/bin:$PATH

%runscript
    exec squire "$@"